datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// --- 1. ç”¨æˆ·æ¨¡å‹ ---
model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  fullName  String
  password  String
  role      Role     @default(student) // "student" | "teacher" | "admin"
  createdAt DateTime @default(now())

  // å…³ç³»å­—æ®µ (ä¿®æ­£äº†å‘½åï¼Œä»¥ä¾¿ä»£ç ä¸­è°ƒç”¨ user.experimentLogs)
  experimentLogs ExperimentLog[]
  aiLogs         AIInteractionLog[]

  // ç­çº§ç›¸å…³
  joinedClasses  ClassMember[]
  createdClasses Class[]       @relation("TeacherClasses")
}

// --- 2. ç­çº§æ¨¡å‹ ---
model Class {
  id         Int      @id @default(autoincrement())
  name       String
  inviteCode String   @unique // ğŸ”¥ ä¿®æ”¹ï¼šç»Ÿä¸€ä¸º inviteCodeï¼ŒåŒ¹é… API ä»£ç 
  teacherId  Int
  createdAt  DateTime @default(now())

  // å…³ç³»
  teacher User          @relation("TeacherClasses", fields: [teacherId], references: [id])
  members ClassMember[]
}

// --- 3. ç­çº§æˆå‘˜è¡¨ ---
model ClassMember {
  id       Int      @id @default(autoincrement())
  classId  Int
  userId   Int
  joinedAt DateTime @default(now()) // ä¿®æ”¹ï¼šç»Ÿä¸€å‘½åä¸º joinedAt

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  class Class @relation(fields: [classId], references: [id], onDelete: Cascade)

  @@unique([classId, userId]) // é˜²æ­¢é‡å¤åŠ å…¥åŒä¸€ä¸ªç­
}

// --- 4. å®éªŒå…ƒæ•°æ® (é¢˜åº“) ---
model Experiment {
  id             Int      @id @default(autoincrement())
  name           String
  subject        Subject  @default(physics)
  description    String?
  sceneAssetPath String // Unity èµ„æºè·¯å¾„
  version        String?
  createdAt      DateTime @default(now())
  coverImage     String?

  // å…³ç³»
  logs   ExperimentLog[]
  aiLogs AIInteractionLog[]
}

// --- 5. å®éªŒè®°å½•è¡¨ (æ ¸å¿ƒä¿®æ”¹) ---
// ğŸ”¥ ä¿®æ”¹ï¼šå°† StudentExperimentLog é‡å‘½åä¸º ExperimentLog
model ExperimentLog {
  id           Int @id @default(autoincrement())
  studentId    Int
  experimentId Int

  score            Int? // æ–°å¢ï¼šåˆ†æ•°
  timeSpent        Int    @default(0) // æ–°å¢ï¼šè€—æ—¶(ç§’)
  completionStatus String @default("è¿›è¡Œä¸­") // "è¿›è¡Œä¸­", "å·²å®Œæˆ"

  startTime DateTime  @default(now())
  endTime   DateTime?

  recordedData Json? // å®éªŒè¿‡ç¨‹æ•°æ®
  actionsLog   Json? // æ“ä½œæ—¥å¿—

  // å…³ç³»
  student    User       @relation(fields: [studentId], references: [id])
  experiment Experiment @relation(fields: [experimentId], references: [id])
}

// --- 6. AI å¯¹è¯è®°å½• ---
model AIInteractionLog {
  id           Int     @id @default(autoincrement())
  studentId    Int
  experimentId Int
  sessionId    String?

  userQuery       String @db.Text // MySQL ä¸­é•¿æ–‡æœ¬å»ºè®®ç”¨ @db.Text
  aiResponse      String @db.Text
  contextSnapshot Json? // å½“æ—¶çš„å®éªŒç¯å¢ƒå¿«ç…§

  createdAt DateTime @default(now())

  student    User       @relation(fields: [studentId], references: [id])
  experiment Experiment @relation(fields: [experimentId], references: [id])
}

// --- æšä¸¾ ---
enum Role {
  student
  teacher
  admin
}

enum Subject {
  physics
  chemistry
  biology
}
